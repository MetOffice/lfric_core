!-----------------------------------------------------------------------------
! Copyright (c) 2017,  Met Office, on behalf of HMSO and Queen's Printer
! For further details please refer to the file LICENCE.original which you
! should have received as part of this distribution.
!-----------------------------------------------------------------------------

!> Test the global_mesh module
!>
module global_mesh_mod_test

  use constants_mod,              only: r_def, i_def, str_max_filename, str_def
  use reference_element_mod,      only: reference_cube_type
  use global_mesh_mod,            only: global_mesh_type
  use global_mesh_map_mod,        only: global_mesh_map_type
  use pFUnit_Mod


  implicit none 

  private
  public :: test_cubedsphere_global_mesh,  &
            test_biperiodic_global_mesh,   &
            setUp, tearDown

  @testCase
  type, public, extends( TestCase ) :: global_mesh_test_type
    private
  contains
    private
    procedure, public :: setUp
    procedure, public :: tearDown
    procedure, public :: test_cubedsphere_global_mesh
    procedure, public :: test_biperiodic_global_mesh
  end type global_mesh_test_type

  character(str_def),          parameter :: mesh_name = 'unit_test'
  character(str_max_filename), parameter :: &
      MultiGridFiles(2) =                   &
                  [ 'data/mesh_C4.nc',      &! 4x4 panel
                    'data/mesh_C8.nc' ]      ! 8x8 panel
  integer(i_def), parameter :: npanels = 6

contains

  subroutine setUp( this )

    implicit none

    class( global_mesh_test_type ), intent( inout ) :: this

  end subroutine setUp

  subroutine tearDown( this )

    implicit none

    class( global_mesh_test_type ), intent( inout ) :: this

  end subroutine tearDown

  ! Test global_mesh module functionality
  !
  @test
  subroutine test_biperiodic_global_mesh( this )

    implicit none

    class( global_mesh_test_type ), intent( inout ) :: this

    type(global_mesh_type) :: global_mesh

    integer(i_def) :: cell_id
    integer(i_def) :: verts(4)
    integer(i_def) :: edges(4)
    integer(i_def) :: cells(4)
    integer(i_def) :: ncells
    integer(i_def) :: ncells_x
    integer(i_def) :: ncells_y
    integer(i_def) :: max_cells_on_vert
    integer(i_def) :: cell_owner
    integer(i_def) :: global_mesh_id1
    integer(i_def) :: global_mesh_id2

    real(r_def) :: dx
    real(r_def) :: dy

    character(len = str_max_filename) :: filename

    !-------------------------------------
    ! Test construction of a biperiodic mesh
    !-------------------------------------

    filename = 'data/mesh_BiP8x8-6000x2000.nc' 
    global_mesh = global_mesh_type( filename, mesh_name )

    ! Check the global mesh id
    global_mesh_id1 = global_mesh%get_id()
    @assertTrue(global_mesh_id1 > 0)

    !
    ! Generate the global_mesh
    cell_id = global_mesh%get_cell_id( 1, 0, 0 )
    @assertEqual( 1, cell_id )
    !
    ! Test functionality of the global_mesh object we've just created
    cell_id = global_mesh%get_cell_id( 1, 2, 2 )
    @assertEqual( 51, cell_id )

    call global_mesh%get_vert_on_cell( 6, verts )
    @assertEqual( 12, verts(1) )
    @assertEqual( 14, verts(2) )
    @assertEqual( 13, verts(3) )
    @assertEqual( 11, verts(4) )

    call global_mesh%get_cell_on_vert( 15, cells )
    @assertEqual(  7, cells(1) )
    @assertEqual(  8, cells(2) )
    @assertEqual( 63, cells(3) )
    @assertEqual( 64, cells(4) )

    call global_mesh%get_edge_on_cell( 6, edges )
    @assertEqual( 14, edges(1) )
    @assertEqual( 18, edges(2) )
    @assertEqual( 17, edges(3) )
    @assertEqual( 16, edges(4) )

    call global_mesh%get_cell_on_edge( 17, cells(1:2) )
    @assertEqual(  6, cells(1) )
    @assertEqual(  7, cells(2) )

    ncells = global_mesh%get_ncells()
    @assertEqual( 64, ncells )

    max_cells_on_vert=global_mesh%get_max_cells_per_vertex()
    @assertEqual( 4, max_cells_on_vert )

  end subroutine test_biperiodic_global_mesh


  @test
  subroutine test_cubedsphere_global_mesh( this )

    implicit none

    class( global_mesh_test_type ), intent( inout ) :: this
 
    type(global_mesh_type) :: global_mesh
    character(len = str_max_filename) :: filename

    integer(i_def) :: cell_id
    integer(i_def) :: verts(4)
    integer(i_def) :: edges(4)
    integer(i_def) :: cells(4)
    integer(i_def) :: ncells
    integer(i_def) :: ncells_x
    integer(i_def) :: ncells_y
    integer(i_def) :: max_cells_on_vert
    integer(i_def) :: cell_owner
    integer(i_def) :: global_mesh_id1
    integer(i_def) :: global_mesh_id2

    real(r_def) :: dx
    real(r_def) :: dy

    !---------------------------------------
    ! Test construction of a cubed-sphere mesh
    !---------------------------------------
    filename = 'data/mesh_C4.nc' 
    global_mesh = global_mesh_type( filename, mesh_name )

    ! Check the global mesh id
    global_mesh_id2 = global_mesh%get_id()
    @assertTrue(global_mesh_id1 /= global_mesh_id2)

    !
    ! Generate the global_mesh
    cell_id = global_mesh%get_cell_id( 1, 0, 0 )
    @assertEqual( 1, cell_id )
    !
    ! Test functionality of the global_mesh object we've just created
    cell_id = global_mesh%get_cell_id( 1, 2, 2 )
    @assertEqual( 74, cell_id )

    call global_mesh%get_vert_on_cell( 6, verts )
    @assertEqual( 10, verts(1) )
    @assertEqual( 11, verts(2) )
    @assertEqual(  7, verts(3) )
    @assertEqual(  6, verts(4) )

    call global_mesh%get_cell_on_vert( 16, cells )
    @assertEqual( 11, cells(1) )
    @assertEqual( 12, cells(2) )
    @assertEqual( 15, cells(3) )
    @assertEqual( 16, cells(4) )

    call global_mesh%get_edge_on_cell( 6, edges )
    @assertEqual( 15, edges(1) )
    @assertEqual( 16, edges(2) )
    @assertEqual( 17, edges(3) )
    @assertEqual(  6, edges(4) )

    call global_mesh%get_cell_on_edge( 13, cells(1:2) )
    @assertEqual(  5, cells(1) )
    @assertEqual( 56, cells(2) )

    ncells = global_mesh%get_ncells()
    @assertEqual( 96, ncells )

    max_cells_on_vert=global_mesh%get_max_cells_per_vertex()
    @assertEqual( 4, max_cells_on_vert )

    cell_owner=global_mesh%get_vert_cell_owner(1)
    @assertEqual( 65, cell_owner )

    cell_owner=global_mesh%get_edge_cell_owner(1)
    @assertEqual( 65, cell_owner )
  end subroutine test_cubedsphere_global_mesh

end module global_mesh_mod_test
